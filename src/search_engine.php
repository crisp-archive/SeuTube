<?php/* * module: *		the search engine for SeuTube * program: *		crisp on 20100814 * description: *  	this is a simple one, using SQL to search *  	if there are enormous number of video to search *		you'd better make a effective one instead of this */define("INNER_ACCESS","1");include_once("config.php");include_once("db/config.php");if($type!='5' && $type!='6'){	include_once("header.php");	if($keyword=="")		header("Location:$host_name/search");}else{	include_once("t_header.php");	if($keyword=="")		header("Location:$host_name/t/find");}include_once("db/movie.php");include_once("mblog.php");echo '<div id="content">';$page=$_GET['page'];$keyword=$_GET['keyword'];$type=$_GET['type'];switch($type){	case '1'://title		$csql="select count(*) from st_movie where title like '%$keyword%'";		$sql="select * from st_movie where title like '%$keyword%' order by vid desc";		search_result($page,$csql,$sql,$type,$keyword);		break;	case '2'://desc		$csql="select count(*) from st_movie where description like '%$keyword%'";		$sql="select * from st_movie where description like '%$keyword%' order by vid desc";		search_result($page,$csql,$sql,$type,$keyword);		break;	case '3'://author		$csql="select count(*) from st_movie where uid in (select uid from st_user where username like '%$keyword%')";		$sql="select * from st_movie where uid in (select uid from st_user where username like '%$keyword%') order by vid desc";		search_result($page,$csql,$sql,$type,$keyword);		break;	case '4'://tag		$csql="select count(*) from st_tags where tag like '%$keyword%'";		$sql="select * from st_movie where vid in (select vid from st_tags where tag like '%$keyword%') order by vid desc";		search_result($page,$csql,$sql,$type,$keyword);		break;	case '5'://microblog name		$csql="select count(*) from st_user where mb_name like '%$keyword%'";		$sql="select * from st_user where mb_name like '%$keyword%'";		search_result($page,$csql,$sql,$type,$keyword);		break;	case '6'://microblog username		$csql="select count(*) from st_user where username like '%$keyword%'";		$sql="select * from st_user where username like '%$keyword%'";		search_result($page,$csql,$sql,$type,$keyword);		break;	default:		header("Location:$host_name/redirect.php?msg=请选择搜索类型!&text=返回继续搜索&link=$host_name/search");		break;}function is_tag($keyword){	$sql="select * from st_tags where tag='$keyword'";	$result=mysql_query($sql);	$row=mysql_fetch_array($result);	if($row)		return true;	else		return false;}function get_micro_time(){	list($usec,$sec)=explode(" ",microtime());	return ((float)$usec+(float)$sec);}function search_result($page,$csql,$sql,$type,$keyword){	$result=mysql_query($csql);	$row=mysql_fetch_array($result);		if(is_tag($keyword) && $type!="4")	{		echo "小提示: <a href=\"$host_name/search_engine.php?type=4&page=1&keyword=$keyword\">$keyword</a>是一个标签，可以查看相同标签的视频.<br>";	}		$count=$row['count(*)'];	if( $count!=0)	{		echo '<div id="content>">';		echo "共搜索到 $count 条记录";		if($count%10)			$tp=$count/10;		else			$tp=$count/10+1;				$start=($page-1)*10;		$nsql=$sql." limit $start,10";		$start_time=get_micro_time();		$result=mysql_query($nsql);		$end_time=get_micro_time();		$usetime=$end_time-$start_time;		echo ", 用时$usetime"."秒";		while($row=mysql_fetch_array($result))		{			$vid=$row['vid'];			$uid=$row['uid'];			if($type!='5' && $type!='6')				search_additem($vid);			else				search_adduitem($uid);		}		echo '<div id="page_ctrl">';		if($page!=1)		{			$a=$page-1;			echo "<a href=\"$host_name/search_engine.php?page=$a&keyword=$keyword&type=$type\">上一页</a>";		}		if($page<$tp)		{			$a=$page+1;			echo "<a href=\"$host_name/search_engine.php?page=$a&keyword=$keyword&type=$type\">下一页</a>";		}		echo '</div>';		echo '</div>';	}	else	{		if($type!='5' && $type!='6')			header("Location:$host_name/redirect.php?msg=未找到相关内容!&text=返回继续搜索&link=$host_name/search");		else			header("Location:$host_name/redirect.php?msg=未找到相关内容!&text=返回继续搜索&link=$host_name/t/find");	}	echo '</div>';	include_once("footer.php");}function search_additem($vid){	$sm=new st_movie();	$sm->vid=$vid;	$sm->get_movie_info();	$su=new st_user($sm->uid,"","");	$su->get_user_info_by_id();	echo	'<div class="search_obj">';	echo 	'<div class="search_header">';	echo	"<a href=\"$host_name/play/$vid\">".$sm->title."</a><br>";	echo	'</div>';	echo 	'<div class="search_info">';	echo 	"人气 $sm->pop, 作者 $su->username, $sm->upload_ts";	echo 	'</div>';	echo 	'<div class="search_desc">';	echo	$sm->desc;	echo 	'</div>';	echo 	'<div class="search_footer">';	if($sm->tags!=null)		echo '标签:';	foreach( $sm->tags as $tag)	{		echo "<a href=\"$host_name/search_engine.php?page=1&keyword=$tag&type=4\">$tag</a>&nbsp;";	}	echo 	'</div>';	echo '</div>';}function search_adduitem($uid){	$curuid=$_COOKIE['uid'];	$smb=new st_mblog($uid);	$smb->get_mb_info();	echo '<div id="mb_m">';	echo '<div id="mb_icon">';	echo "<img src=\"$smb->icon\" />&nbsp;";	echo '</div>';	echo '<div id="mb_name">';	echo '<div id="mb_nm">';	echo $smb->mb_name;	echo '</div>';	echo '<div id="mb_at">';	echo "<a href=\"$host_name/t/u/$smb->uid\">@$smb->username</a>";	echo '</div>';	echo '<div id="mb_briefinfo">';	echo "<div>广播 <a href=\"$host_name/t/broadcast/$uid\">".$smb->get_post_num()."</a></div>";	echo "<div>听众 <a href=\"$host_name/t/follower/$uid\">".$smb->get_listener_num()."</a></div>";	echo "<div>收听 <a href=\"$host_name/t/following/$uid\">".$smb->get_listened_num()."</a></div>";	echo '</div>';	echo '</div>';	echo '<div id="mb_m_right">';	echo '<div id="mb_m_bio">';	echo '<b>介绍:&nbsp;</b>';	echo $smb->mb_bio;	echo '</div>';	echo '</div>';	echo '</div>';}?>